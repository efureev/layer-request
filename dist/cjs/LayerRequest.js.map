{"version":3,"file":"LayerRequest.js","names":["o","Object","create","buildAxios","axiosRequestConfig","cancelController","AbortController","a","axios","signal","defaultBuilder","instance","setAxiosInstances","selectedConfig","LayerRequest","manager","layerConfigManager","extra","builder","layer","layerName","list","shift","Error","currentLayer","getLayer","clone","setName","getName","setExtra","applyInterceptors","interceptors","axiosInstances","undefined","callback","cb","successCb","errorCb","Array","isArray","length","isFunction","target","source","forEach","use","normalizeInterceptors","request","registerInterceptors","response","instances","$layerRequest","reason","abort","buildLayerRequest"],"sources":["../../src/LayerRequest.ts"],"sourcesContent":["import type { AxiosInstance, AxiosInterceptorManager, AxiosRequestConfig, AxiosResponse } from 'axios'\nimport axios from 'axios'\nimport isFunction from '@feugene/mu/is/isFunction'\nimport type { LayerConfigManager } from './LayerConfigManager'\nimport layerConfigManager from './LayerConfigManager'\nimport type {\n  ConfigLayerInterceptors,\n  ExtraProperties,\n  InterceptorErrorParam,\n  InterceptorFn,\n  InterceptorNormal,\n  InterceptorSuccessParam,\n  LayerConfig,\n  LayerConfigStringable,\n} from './LayerConfig'\nimport { Undef } from './global'\n\ntype BuilderCreator = (r: LayerRequest) => void\ntype AxiosCreator = (axiosRequestConfig?: AxiosRequestConfig) => AxiosInstances\n\ninterface AxiosInstances {\n  axios?: AxiosInstance\n  cancelController?: AbortController\n}\n\nconst o = () => Object.create(null)\n\nconst buildAxios: AxiosCreator = (axiosRequestConfig: AxiosRequestConfig = o()): AxiosInstances => {\n  // to cancel the request:\n  // controller.abort()\n  const cancelController = new AbortController()\n\n  const a = axios.create({\n    signal: cancelController.signal,\n    ...axiosRequestConfig,\n  })\n\n  return {\n    cancelController,\n    axios: a,\n  }\n}\n\nconst defaultBuilder: BuilderCreator = (instance: LayerRequest): void => {\n  instance.setAxiosInstances(buildAxios(instance.selectedConfig?.axiosRequestConfig))\n}\n\nexport default class LayerRequest {\n  public readonly manager: LayerConfigManager\n  public readonly extra: ExtraProperties\n  public builder: BuilderCreator\n\n  public selectedConfig?: LayerConfig\n\n  private axiosInstances: AxiosInstances = o()\n\n  constructor(manager: LayerConfigManager = layerConfigManager, extra: ExtraProperties = o()) {\n    this.manager = manager\n    this.extra = extra\n\n    this.builder = defaultBuilder\n  }\n\n  useConfig(layer: LayerConfigStringable, extra: ExtraProperties = o()): AxiosInstance {\n    if (!layer) {\n      const layerName = this.manager.list().shift()\n      if (!layerName) {\n        throw Error('Missing name of a LayerConfig')\n      }\n      layer = layerName\n    }\n\n    const currentLayer: LayerConfig = <LayerConfig>this.manager.getLayer(layer, true)\n    this.selectedConfig = currentLayer.clone(true)\n    this.selectedConfig.setName(currentLayer.getName())\n\n    this.selectedConfig.setExtra(extra)\n\n    this.builder(this)\n\n    this.applyInterceptors(this.selectedConfig.interceptors)\n\n    return <AxiosInstance>this.axiosInstances.axios\n  }\n\n  reset() {\n    this.selectedConfig = undefined\n    this.builder = defaultBuilder\n    this.axiosInstances.axios = undefined\n    this.axiosInstances.cancelController = undefined\n\n    return this\n  }\n\n  private normalizeInterceptors<T>(callback: InterceptorFn<T>): InterceptorNormal<T> {\n    const cb = callback(<LayerConfig>this.selectedConfig, this.extra)\n    let successCb: InterceptorSuccessParam<T>\n    let errorCb: InterceptorErrorParam\n\n    if (Array.isArray(cb) && cb.length > 1) {\n      successCb = cb[0]\n      errorCb = isFunction(cb[1]) ? cb[1] : undefined //(error) => Promise.reject(error)\n      return [successCb, errorCb]\n    }\n\n    return [<InterceptorSuccessParam<T>>cb, undefined]\n  }\n\n  private registerInterceptors<T>(target: AxiosInterceptorManager<T>, ...source: InterceptorFn<T>[]) {\n    source.forEach(callback => {\n      if (!isFunction(callback)) {\n        return\n      }\n      target.use<T>(...this.normalizeInterceptors<T>(callback))\n    })\n  }\n\n  private applyInterceptors(interceptors: ConfigLayerInterceptors) {\n    if (!this.selectedConfig || !this.axiosInstances.axios) {\n      throw Error('To handle request you should choose a LayerConfig with `useConfig`!')\n    }\n    interceptors.request &&\n    this.registerInterceptors<AxiosRequestConfig>(\n      this.axiosInstances.axios.interceptors.request,\n      ...interceptors.request,\n    )\n    interceptors.response &&\n    this.registerInterceptors<AxiosResponse>(\n      this.axiosInstances.axios.interceptors.response,\n      ...interceptors.response,\n    )\n  }\n\n  public setAxiosInstances(instances: AxiosInstances) {\n    if (!instances.axios) {\n      throw Error('You should create Axios instance')\n    }\n    // @ts-ignore\n    instances.axios.$layerRequest = this\n    this.axiosInstances = instances\n  }\n\n  public getAxios(): Undef<AxiosInstance> {\n    return this.axiosInstances.axios\n  }\n\n  public getCancel(): Undef<AbortController> {\n    return this.axiosInstances.cancelController\n  }\n\n  public abort(reason?: any): void {\n    this.axiosInstances.cancelController && this.axiosInstances.cancelController.abort(reason)\n  }\n}\n\nexport function buildLayerRequest(extra: ExtraProperties = o(), manager?: LayerConfigManager) {\n  return new LayerRequest(manager, extra)\n}\n"],"mappings":"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"}