{"version":3,"file":"LayerRequest.js","names":["o","Object","create","buildAxios","axiosRequestConfig","cancelToken","axios","CancelToken","source","a","token","defaultBuilder","instance","setAxiosInstances","selectedConfig","LayerRequest","manager","layerConfigManager","extra","builder","layer","layerName","list","shift","Error","currentLayer","getLayer","clone","setName","getName","isObject","setExtra","getExtra","applyInterceptors","interceptors","axiosInstances","useConfig","undefined","callback","cb","successCb","errorCb","Array","isArray","length","isFunction","target","forEach","use","normalizeInterceptors","request","registerInterceptors","response","instances","$layerRequest","buildLayerRequest"],"sources":["../../src/LayerRequest.ts"],"sourcesContent":["import axios, {\n  AxiosInstance,\n  AxiosInterceptorManager,\n  AxiosRequestConfig,\n  AxiosResponse,\n  CancelTokenSource,\n} from 'axios'\n\nimport { isFunction, isObject } from '@feugene/mu'\nimport type { LayerConfigManager } from './LayerConfigManager'\nimport layerConfigManager from './LayerConfigManager'\nimport type {\n  ConfigLayerInterceptors,\n  ExtraProperties,\n  InterceptorErrorParam,\n  InterceptorFn,\n  InterceptorNormal,\n  InterceptorSuccessParam,\n  LayerConfigStringable,\n} from './LayerConfig'\nimport LayerConfig from './LayerConfig'\nimport { Recordable } from './global'\n\ntype BuilderCreator = (r: LayerRequest) => void\ntype AxiosCreator = (axiosRequestConfig?: AxiosRequestConfig) => AxiosInstances\n\ninterface AxiosInstances {\n  axios?: AxiosInstance\n  cancelToken?: CancelTokenSource\n}\n\nconst o = () => Object.create(null)\n\nconst buildAxios: AxiosCreator = (axiosRequestConfig: AxiosRequestConfig = o()): AxiosInstances => {\n  const cancelToken = axios.CancelToken.source()\n  const a = axios.create({\n    cancelToken: cancelToken.token,\n    ...axiosRequestConfig,\n  })\n\n  return {\n    cancelToken,\n    axios: a,\n  }\n}\n\nconst defaultBuilder: BuilderCreator = (instance: LayerRequest): void => {\n  instance.setAxiosInstances(buildAxios(instance.selectedConfig?.axiosRequestConfig))\n}\n\nexport type LayerRequestExtraProperties = Recordable\n\nexport default class LayerRequest {\n  public readonly manager: LayerConfigManager\n  public readonly extra: LayerRequestExtraProperties\n  public builder: BuilderCreator\n\n  public selectedConfig?: LayerConfig\n\n  private axiosInstances: AxiosInstances = o()\n\n  constructor(manager: LayerConfigManager = layerConfigManager, extra: LayerRequestExtraProperties = o()) {\n    this.manager = manager\n    this.extra = extra\n\n    this.builder = defaultBuilder\n  }\n\n  useConfig(layer: LayerConfigStringable, extra: ExtraProperties = o()): AxiosInstance {\n    if (!layer) {\n      const layerName = this.manager.list().shift()\n      if (!layerName) {\n        throw Error('Missing name of a LayerConfig')\n      }\n      layer = layerName\n    }\n\n    const currentLayer: LayerConfig = <LayerConfig>this.manager.getLayer(layer, true)\n    this.selectedConfig = currentLayer.clone()\n    this.selectedConfig.setName(currentLayer.getName())\n\n    if (isObject(extra)) {\n      this.selectedConfig.setExtra(currentLayer.getExtra())\n    }\n\n    this.builder(this)\n\n    this.applyInterceptors(this.selectedConfig.interceptors)\n\n    return <AxiosInstance>this.axiosInstances.axios\n  }\n\n  /**\n   * @deprecated\n   * @use `useConfig`\n   */\n  build(layer: LayerConfigStringable, extra: ExtraProperties = o()): AxiosInstance {\n    return this.useConfig(layer, extra)\n  }\n\n  reset() {\n    this.selectedConfig = undefined\n    this.builder = defaultBuilder\n    this.axiosInstances.axios = undefined\n    this.axiosInstances.cancelToken = undefined\n\n    return this\n  }\n\n  private normalizeInterceptors<T>(callback: InterceptorFn<T>): InterceptorNormal<T> {\n    const cb = callback(<LayerConfig>this.selectedConfig, this.extra)\n    let successCb: InterceptorSuccessParam<T>\n    let errorCb: InterceptorErrorParam\n\n    if (Array.isArray(cb) && cb.length > 1) {\n      successCb = cb[0]\n      errorCb = isFunction(cb[1]) ? cb[1] : undefined //(error) => Promise.reject(error)\n      return [successCb, errorCb]\n    }\n\n    return [<InterceptorSuccessParam<T>>cb, undefined]\n  }\n\n  private registerInterceptors<T>(target: AxiosInterceptorManager<T>, ...source: InterceptorFn<T>[]) {\n    source.forEach(callback => {\n      if (!isFunction(callback)) {\n        return\n      }\n      target.use<T>(...this.normalizeInterceptors<T>(callback))\n    })\n  }\n\n  private applyInterceptors(interceptors: ConfigLayerInterceptors) {\n    if (!this.selectedConfig || !this.axiosInstances.axios) {\n      throw Error('To handle request you should choose a LayerConfig with `useConfig`!')\n    }\n    interceptors.request &&\n    this.registerInterceptors<AxiosRequestConfig>(\n      this.axiosInstances.axios.interceptors.request,\n      ...interceptors.request,\n    )\n    interceptors.response &&\n    this.registerInterceptors<AxiosResponse>(\n      this.axiosInstances.axios.interceptors.response,\n      ...interceptors.response,\n    )\n  }\n\n  public setAxiosInstances(instances: AxiosInstances) {\n    if (!instances.axios) {\n      throw Error('You should create Axios instance')\n    }\n    // @ts-ignore\n    instances.axios.$layerRequest = this\n    this.axiosInstances = instances\n  }\n\n  public getAxios(): AxiosInstance | undefined {\n    return this.axiosInstances.axios\n  }\n}\n\nexport function buildLayerRequest(extra: LayerRequestExtraProperties = o(), manager?: LayerConfigManager) {\n  return new LayerRequest(manager, extra)\n}\n"],"mappings":"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"}