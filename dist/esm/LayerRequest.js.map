{"version":3,"file":"LayerRequest.js","names":["axios","isFunction","isObject","layerConfigManager","o","Object","create","buildAxios","axiosRequestConfig","cancelController","AbortController","a","signal","defaultBuilder","instance","setAxiosInstances","selectedConfig","LayerRequest","axiosInstances","constructor","manager","extra","builder","useConfig","layer","layerName","list","shift","Error","currentLayer","getLayer","clone","setName","getName","setExtra","getExtra","applyInterceptors","interceptors","build","reset","undefined","normalizeInterceptors","callback","cb","successCb","errorCb","Array","isArray","length","registerInterceptors","target","source","forEach","use","request","response","instances","$layerRequest","getAxios","getCancel","abort","reason","buildLayerRequest"],"sources":["../../src/LayerRequest.ts"],"sourcesContent":["import type { AxiosInstance, AxiosInterceptorManager, AxiosRequestConfig, AxiosResponse } from 'axios'\nimport axios from 'axios'\n\nimport { isFunction, isObject } from '@feugene/mu'\nimport type { LayerConfigManager } from './LayerConfigManager'\nimport layerConfigManager from './LayerConfigManager'\nimport type {\n  ConfigLayerInterceptors,\n  ExtraProperties,\n  InterceptorErrorParam,\n  InterceptorFn,\n  InterceptorNormal,\n  InterceptorSuccessParam,\n  LayerConfig,\n  LayerConfigStringable,\n} from './LayerConfig'\nimport { Undef } from './global'\n\ntype BuilderCreator = (r: LayerRequest) => void\ntype AxiosCreator = (axiosRequestConfig?: AxiosRequestConfig) => AxiosInstances\n\ninterface AxiosInstances {\n  axios?: AxiosInstance\n  cancelController?: AbortController\n}\n\nconst o = () => Object.create(null)\n\nconst buildAxios: AxiosCreator = (axiosRequestConfig: AxiosRequestConfig = o()): AxiosInstances => {\n  // to cancel the request:\n  // controller.abort()\n  const cancelController = new AbortController()\n\n  const a = axios.create({\n    signal: cancelController.signal,\n    ...axiosRequestConfig,\n  })\n\n  return {\n    cancelController,\n    axios: a,\n  }\n}\n\nconst defaultBuilder: BuilderCreator = (instance: LayerRequest): void => {\n  instance.setAxiosInstances(buildAxios(instance.selectedConfig?.axiosRequestConfig))\n}\n\nexport default class LayerRequest {\n  public readonly manager: LayerConfigManager\n  public readonly extra: ExtraProperties\n  public builder: BuilderCreator\n\n  public selectedConfig?: LayerConfig\n\n  private axiosInstances: AxiosInstances = o()\n\n  constructor(manager: LayerConfigManager = layerConfigManager, extra: ExtraProperties = o()) {\n    this.manager = manager\n    this.extra = extra\n\n    this.builder = defaultBuilder\n  }\n\n  useConfig(layer: LayerConfigStringable, extra: ExtraProperties = o()): AxiosInstance {\n    if (!layer) {\n      const layerName = this.manager.list().shift()\n      if (!layerName) {\n        throw Error('Missing name of a LayerConfig')\n      }\n      layer = layerName\n    }\n\n    const currentLayer: LayerConfig = <LayerConfig>this.manager.getLayer(layer, true)\n    this.selectedConfig = currentLayer.clone()\n    this.selectedConfig.setName(currentLayer.getName())\n\n    this.selectedConfig.setExtra({\n      ...currentLayer.getExtra(),\n      ...(isObject(extra) ? extra : {}),\n    })\n\n    this.builder(this)\n\n    this.applyInterceptors(this.selectedConfig.interceptors)\n\n    return <AxiosInstance>this.axiosInstances.axios\n  }\n\n  /**\n   * @deprecated\n   * @use `useConfig`\n   */\n  build(layer: LayerConfigStringable, extra: ExtraProperties = o()): AxiosInstance {\n    return this.useConfig(layer, extra)\n  }\n\n  reset() {\n    this.selectedConfig = undefined\n    this.builder = defaultBuilder\n    this.axiosInstances.axios = undefined\n    this.axiosInstances.cancelController = undefined\n\n    return this\n  }\n\n  private normalizeInterceptors<T>(callback: InterceptorFn<T>): InterceptorNormal<T> {\n    const cb = callback(<LayerConfig>this.selectedConfig, this.extra)\n    let successCb: InterceptorSuccessParam<T>\n    let errorCb: InterceptorErrorParam\n\n    if (Array.isArray(cb) && cb.length > 1) {\n      successCb = cb[0]\n      errorCb = isFunction(cb[1]) ? cb[1] : undefined //(error) => Promise.reject(error)\n      return [successCb, errorCb]\n    }\n\n    return [<InterceptorSuccessParam<T>>cb, undefined]\n  }\n\n  private registerInterceptors<T>(target: AxiosInterceptorManager<T>, ...source: InterceptorFn<T>[]) {\n    source.forEach(callback => {\n      if (!isFunction(callback)) {\n        return\n      }\n      target.use<T>(...this.normalizeInterceptors<T>(callback))\n    })\n  }\n\n  private applyInterceptors(interceptors: ConfigLayerInterceptors) {\n    if (!this.selectedConfig || !this.axiosInstances.axios) {\n      throw Error('To handle request you should choose a LayerConfig with `useConfig`!')\n    }\n    interceptors.request &&\n      this.registerInterceptors<AxiosRequestConfig>(\n        this.axiosInstances.axios.interceptors.request,\n        ...interceptors.request\n      )\n    interceptors.response &&\n      this.registerInterceptors<AxiosResponse>(\n        this.axiosInstances.axios.interceptors.response,\n        ...interceptors.response\n      )\n  }\n\n  public setAxiosInstances(instances: AxiosInstances) {\n    if (!instances.axios) {\n      throw Error('You should create Axios instance')\n    }\n    // @ts-ignore\n    instances.axios.$layerRequest = this\n    this.axiosInstances = instances\n  }\n\n  public getAxios(): Undef<AxiosInstance> {\n    return this.axiosInstances.axios\n  }\n\n  public getCancel(): Undef<AbortController> {\n    return this.axiosInstances.cancelController\n  }\n\n  public abort(reason?: any): void {\n    this.axiosInstances.cancelController && this.axiosInstances.cancelController.abort(reason)\n  }\n}\n\nexport function buildLayerRequest(extra: ExtraProperties = o(), manager?: LayerConfigManager) {\n  return new LayerRequest(manager, extra)\n}\n"],"mappings":"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"}